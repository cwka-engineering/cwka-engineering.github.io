{% if page.toc != false %}
<div class="toc-sidebar" id="toc-sidebar">
  <h3>On This Page</h3>
  <ul id="toc-list"></ul>
</div>

<script>
(function() {
  // Generate TOC from headings
  function generateTOC() {
    const headings = document.querySelectorAll('.page-content h2, .page-content h3, .page-content h4');
    const tocList = document.getElementById('toc-list');
    
    if (!tocList || headings.length === 0) {
      const sidebar = document.getElementById('toc-sidebar');
      if (sidebar) sidebar.style.display = 'none';
      return;
    }
    
    tocList.innerHTML = '';
    let tocLevel = 0;
    
    headings.forEach((heading, index) => {
      // Skip if heading is in a blockquote or other excluded element
      if (heading.closest('blockquote')) return;
      
      const id = heading.id || `heading-${index}`;
      if (!heading.id) {
        heading.id = id;
      }
      
      const level = parseInt(heading.tagName.charAt(1));
      const text = heading.textContent.trim();
      
      const li = document.createElement('li');
      li.className = `toc-level-${level - 1}`;
      
      const a = document.createElement('a');
      a.href = `#${id}`;
      a.textContent = text;
      a.addEventListener('click', function(e) {
        e.preventDefault();
        heading.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // Update URL without jumping
        history.pushState(null, null, `#${id}`);
      });
      
      li.appendChild(a);
      tocList.appendChild(li);
    });
    
    // Highlight active section on scroll
    function updateActiveTOC() {
      const scrollPos = window.scrollY + 100;
      let activeHeading = null;
      
      headings.forEach((heading) => {
        if (heading.offsetTop <= scrollPos) {
          activeHeading = heading;
        }
      });
      
      if (activeHeading) {
        const tocLinks = tocList.querySelectorAll('a');
        tocLinks.forEach(link => {
          link.classList.remove('active');
          if (link.getAttribute('href') === `#${activeHeading.id}`) {
            link.classList.add('active');
          }
        });
      }
    }
    
    window.addEventListener('scroll', updateActiveTOC);
    updateActiveTOC();
  }
  
  // Adjust main content margin when TOC is present
  function adjustContentMargin() {
    const toc = document.getElementById('toc-sidebar');
    const content = document.querySelector('.page-content, .wrapper');
    if (toc && content && window.innerWidth > 1200) {
      content.classList.add('page-content-with-toc');
    }
  }
  
  // Run on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      generateTOC();
      adjustContentMargin();
    });
  } else {
    generateTOC();
    adjustContentMargin();
  }
  
  // Adjust on resize
  window.addEventListener('resize', adjustContentMargin);
})();
</script>
{% endif %}

