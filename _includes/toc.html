{% if page.toc != false %}
<script>
(function() {
  // Create TOC sidebar element and append to body
  function createTOCSidebar() {
    let sidebar = document.getElementById('toc-sidebar');
    if (!sidebar) {
      sidebar = document.createElement('div');
      sidebar.id = 'toc-sidebar';
      sidebar.className = 'toc-sidebar';
      sidebar.innerHTML = '<h3>On This Page</h3><ul id="toc-list"></ul>';
      // Append directly to body, right after the opening body tag content
      // This ensures it's not constrained by any wrapper or footer
      const main = document.querySelector('main');
      if (main && main.parentNode === document.body) {
        // Insert after main but before footer
        document.body.insertBefore(sidebar, main.nextSibling);
      } else {
        // Fallback: append to body
        document.body.appendChild(sidebar);
      }
      // Force positioning to ensure it's fixed
      sidebar.style.position = 'fixed';
      sidebar.style.top = '60px';
      sidebar.style.right = '20px';
      sidebar.style.zIndex = '1000';
    }
    return sidebar;
  }
  
  // Generate TOC from headings
  function generateTOC() {
    const headings = document.querySelectorAll('.wrapper h2, .wrapper h3, .wrapper h4, .page-content h2, .page-content h3, .page-content h4');
    const sidebar = createTOCSidebar();
    const tocList = document.getElementById('toc-list');
    
    if (!tocList || headings.length === 0) {
      sidebar.style.display = 'none';
      return;
    }
    
    sidebar.style.display = 'block';
    tocList.innerHTML = '';
    let tocLevel = 0;
    
    headings.forEach((heading, index) => {
      // Skip if heading is in a blockquote or other excluded element
      if (heading.closest('blockquote')) return;
      
      const id = heading.id || `heading-${index}`;
      if (!heading.id) {
        heading.id = id;
      }
      
      const level = parseInt(heading.tagName.charAt(1));
      const text = heading.textContent.trim();
      
      const li = document.createElement('li');
      li.className = `toc-level-${level - 1}`;
      
      const a = document.createElement('a');
      a.href = `#${id}`;
      a.textContent = text;
      a.addEventListener('click', function(e) {
        e.preventDefault();
        heading.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // Update URL without jumping
        history.pushState(null, null, `#${id}`);
      });
      
      li.appendChild(a);
      tocList.appendChild(li);
    });
    
    // Highlight active section on scroll
    function updateActiveTOC() {
      const scrollPos = window.scrollY + 100;
      let activeHeading = null;
      
      headings.forEach((heading) => {
        if (heading.offsetTop <= scrollPos) {
          activeHeading = heading;
        }
      });
      
      if (activeHeading) {
        const tocLinks = tocList.querySelectorAll('a');
        tocLinks.forEach(link => {
          link.classList.remove('active');
          if (link.getAttribute('href') === `#${activeHeading.id}`) {
            link.classList.add('active');
          }
        });
      }
    }
    
    window.addEventListener('scroll', updateActiveTOC);
    updateActiveTOC();
    
    // Adjust content margin after TOC is generated
    adjustContentMargin();
  }
  
  // Adjust main content margin when TOC is present
  function adjustContentMargin() {
    const toc = document.getElementById('toc-sidebar');
    const wrapper = document.querySelector('.wrapper');
    const pageContent = document.querySelector('.page-content');
    
    if (toc && toc.style.display !== 'none' && window.innerWidth > 1200) {
      if (wrapper) {
        wrapper.classList.add('page-content-with-toc');
      }
      if (pageContent) {
        pageContent.classList.add('page-content-with-toc');
      }
    } else {
      if (wrapper) {
        wrapper.classList.remove('page-content-with-toc');
      }
      if (pageContent) {
        pageContent.classList.remove('page-content-with-toc');
      }
    }
  }
  
  // Run on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      generateTOC();
    });
  } else {
    generateTOC();
  }
  
  // Adjust on resize
  window.addEventListener('resize', function() {
    adjustContentMargin();
    // Regenerate TOC if needed (in case headings changed)
    const headings = document.querySelectorAll('.wrapper h2, .wrapper h3, .wrapper h4');
    if (headings.length > 0) {
      generateTOC();
    }
  });
})();
</script>
{% endif %}

